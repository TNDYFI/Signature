<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DYFI — E-Signature </title>
<link rel="shortcut icon" href="images/preview.jpg" type="image/svg+xml">
<meta property="og:title" content="DYFI Tnpsc Digital Signature Moment">
<meta property="og:description" content=" Dyfi - Tnpsc Digital Signature - DYFI Tamil Nadu">
<meta property="og:image" content="https://tndyfi.github.io/Signature/images/previews.png">
<meta property="og:url" content="https://tndyfi.github.io/Signature/">
<meta property="og:type" content="website">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://tndyfi.github.io/Signature/images/previews.png">

<script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.8/firebase-storage-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{font-family:Inter,Arial,sans-serif;background:#f4f7f9;color:#111;margin:0;padding:18px;text-align:center}
.container{max-width:900px;margin:0 auto}
h2{margin:6px 0}
input,select{width:90%;max-width:420px;padding:12px;margin:8px 0;border-radius:8px;border:1px solid #ccc}
#box{width:95%;max-width:800px;height:50vh;border-radius:12px;border:2px solid #333;background:#fff;margin:12px auto;position:relative;overflow:hidden}
canvas{width:100%;height:100%;display:block}
.controls{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:12px 0}
button{padding:12px 18px;border-radius:8px;border:0;color:#fff;background:#1a73e8;cursor:pointer;font-weight:600}
button.danger{background:#d32f2f}
button.green{background:#0a8f08}
.counterRow{display:flex;gap:12px;justify-content:center;margin-top:10px}
.counter{background:#fff;padding:8px 12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
.message-box{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);visibility:hidden;opacity:0;transition:opacity .2s}
.message-box.active{visibility:visible;opacity:1}
.message-content{background:#fff;padding:20px;border-radius:10px;max-width:320px;text-align:center}
.small{font-size:13px;color:#666}
</style>
</head>
<body>
<div class="container">
  <h2>DYFI நடத்தும் 1-லட்சம் TNPSC பணியிடங்களை நிரப்பக் கோரி கையெழுத்து இயக்கம் E-Signature </h2>
  <p class="small"> தலை நிமிருமா 
தமிழக இளைஞர்களின் வாழ்வு.? 
சட்டமன்ற தேர்தலுக்கு முன் TNPSC தேர்வு மூலம் 1 இலட்சம் காலி பணியிடங்களை நிரப்பிடக்கோரி டிசம்பர் 1 தமிழ்நாடு முழுவதும் வேலை கேட்டு 
ஒரு நாள் காத்திருப்பு இயக்கம்! </p>

  <input id="name" placeholder="Enter Your Name" />
  <input id="number" placeholder="Enter Phone Number" type="tel" />

  <select id="district" required>
    <option value="" disabled selected>Choose Your District</option>
    <option value="Ariyalur">அரியலூர் - Ariyalur</option>
    <option value="Chengalpattu">செங்கல்பட்டு - Chengalpattu</option>
    <option value="Chennai">சென்னை - Chennai</option>
    <option value="Coimbatore">கோயம்புத்தூர் - Coimbatore</option>
    <option value="Cuddalore">கடலூர் - Cuddalore</option>
    <option value="Dharmapuri">தருமபுரி - Dharmapuri</option>
    <option value="Dindigul">திண்டுக்கல் - Dindigul</option>
    <option value="Erode">ஈரோடு - Erode</option>
    <option value="Kallakurichi">கள்ளக்குறிச்சி - Kallakurichi</option>
    <option value="Kancheepuram">காஞ்சிபுரம் - Kancheepuram</option>
    <option value="Kanyakumari">கன்னியாகுமரி - Kanyakumari</option>
    <option value="Karur">கரூர் - Karur</option>
    <option value="Krishnagiri">கிருஷ்ணகிரி - Krishnagiri</option>
    <option value="Madurai">மதுரை - Madurai</option>
    <option value="Mayiladuthurai">மயிலாடுதுறை - Mayiladuthurai</option>
    <option value="Nagapattinam">நாகப்பட்டினம் - Nagapattinam</option>
    <option value="Namakkal">நாமக்கல் - Namakkal</option>
    <option value="Nilgiris">நீலகிரி - Nilgiris</option>
    <option value="Perambalur">பெரம்பலூர் - Perambalur</option>
    <option value="Pudukkottai">புதுக்கோட்டை - Pudukkottai</option>
    <option value="Ramanathapuram">இராமநாதபுரம் - Ramanathapuram</option>
    <option value="Ranipet">இராணிப்பேட்டை - Ranipet</option>
    <option value="Salem">சேலம் - Salem</option>
    <option value="Sivaganga">சிவகங்கை - Sivaganga</option>
    <option value="Tenkasi">தென்காசி - Tenkasi</option>
    <option value="Thanjavur">தஞ்சாவூர் - Thanjavur</option>
    <option value="Theni">தேனி - Theni</option>
    <option value="Thoothukudi">தூத்துக்குடி - Thoothukudi</option>
    <option value="Tiruchirappalli">திருச்சிராப்பள்ளி - Tiruchirappalli</option>
    <option value="Tirunelveli">திருநெல்வேலி - Tirunelveli</option>
    <option value="Tirupattur">திருப்பத்தூர் - Tirupattur</option>
    <option value="Tiruppur">திருப்பூர் - Tiruppur</option>
    <option value="Tiruvallur">திருவள்ளூர் - Tiruvallur</option>
    <option value="Tiruvannamalai">திருவண்ணாமலை - திருவண்ணாமலை</option>
    <option value="Tiruvarur">திருவாரூர் - Tiruvarur</option>
    <option value="Vellore">வேலூர் - Vellore</option>
    <option value="Viluppuram">விழுப்புரம் - Viluppuram</option>
    <option value="Virudhunagar">விருதுநகர் - Virudhunagar</option>
</select>

  <div id="box"><canvas id="canvas"></canvas></div>

  <div class="controls">
    <button id="clearBtn" class="danger">Clear Signature</button>
    <div style="position:relative;display:inline-block">
      <button id="pdfMenuBtn">Preview / Download PDF ▾</button>
      <div id="pdfMenu" style="display:none;position:absolute;left:0;top:44px;background:#fff;padding:8px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12)">
        <button id="previewBtn" style="width:200px;margin:6px;background:#444;color:#fff">Preview PDF</button><br/>
        <button id="downloadBtn" style="width:200px;margin:6px;background:#555;color:#fff">Download PDF</button>
      </div>
    </div>
    <button id="submitBtn" class="green">Submit Details</button>
  </div>

  <div class="counterRow" style="margin-top:16px">
    <div class="counter">Signatures: <strong id="sigCount">—</strong></div>
    <div class="counter">Emails sent: <strong id="mailCount">—</strong></div>
  </div>

  <div class="small" style="margin-top:12px">DYFI - தமிழ்நாடு மாநிலக்குழு</div>
</div>

<div id="msg" class="message-box"><div class="message-content"><p id="msgText"></p><button id="msgOk">OK</button></div></div>

<script>
/* ----------------------------- Firebase config ----------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBLyf_dz6xPC9wdthZSVtpatkc8JgFhE4Q",
  authDomain: "chatbox-chats.firebaseapp.com",
  databaseURL: "https://chatbox-chats-default-rtdb.firebaseio.com",
  projectId: "chatbox-chats",
  storageBucket: "chatbox-chats.appspot.com",
  messagingSenderId: "10200860576",
  appId: "1:10200860576:android:262315d86f6d1732ddc6c5"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

/* ----------------------------- UI refs ----------------------------- */
const canvas = document.getElementById('canvas');
const box = document.getElementById('box');
const clearBtn = document.getElementById('clearBtn');
const pdfMenuBtn = document.getElementById('pdfMenuBtn');
const pdfMenu = document.getElementById('pdfMenu');
const previewBtn = document.getElementById('previewBtn');
const downloadBtn = document.getElementById('downloadBtn');
const submitBtn = document.getElementById('submitBtn');
const sigCountEl = document.getElementById('sigCount');
const mailCountEl = document.getElementById('mailCount');
const msg = document.getElementById('msg');
const msgText = document.getElementById('msgText');
const msgOk = document.getElementById('msgOk');

function showMessage(text){
  msgText.innerHTML = text;
  msg.classList.add('active');
  msg.style.visibility = 'visible';
  msg.style.opacity = '1';
}
msgOk.onclick = ()=> { msg.classList.remove('active'); msg.style.visibility='hidden'; msg.style.opacity='0'; };

/* ----------------------------- Canvas + SignaturePad ----------------------------- */
let signaturePad;
function setupCanvas(){
  const ratio = Math.max(window.devicePixelRatio || 1, 1);
  canvas.width = box.clientWidth * ratio;
  canvas.height = box.clientHeight * ratio;
  canvas.getContext('2d').scale(ratio, ratio);
  if(!signaturePad) signaturePad = new SignaturePad(canvas, { backgroundColor:'transparent', penColor:'blue', minWidth:1.2, maxWidth:3 });
}
window.addEventListener('resize', ()=> { setupCanvas(); });
setupCanvas();

clearBtn.onclick = ()=> signaturePad.clear();

/* ----------------------------- PDF creation (returns blob) ----------------------------- */
// Using the favicon image as the logo. Ensure the path/URL is correct and accessible.
const LOGO_URL = 'https://tndyfi.github.io/Signature/images/previews.png'; 

async function createPDFBlob(){
  const { jsPDF } = window.jspdf;
  
  // *** RESTORED TO LANDSCAPE FOR BETTER A4 LAYOUT ***
  const pdf = new jsPDF('landscape','pt','a5'); 

  const pdfW = pdf.internal.pageSize.getWidth();
  const pdfH = pdf.internal.pageSize.getHeight();

  const name = (document.getElementById('name').value||'').trim() || 'Unsigned User';
  const district = (document.getElementById('district').value||'Not selected');
  const number = (document.getElementById('number').value||'');
  
  // --- PDF Content Layout ---
  
  // 1. Logo (Top-left)
  try {
    const logoImg = new Image();
    logoImg.crossOrigin = 'anonymous'; 
    logoImg.src = LOGO_URL;
    await new Promise((resolve, reject) => {
        logoImg.onload = resolve;
        logoImg.onerror = reject;
    });
    // Add image: dataUrl, format, x, y, width, height
    // Adjusted logo coordinates: X=40 (left margin), Y=20 (top margin), Size=60x60
    pdf.addImage(logoImg, 'JPEG', 50, 30, 70, 70); 
  } catch(e) {
    console.warn("Logo failed to load:", e);
  }

  // 2. Title (Bold and Larger) - positioned centrally, aligned with the top area
  pdf.setFontSize(28); 
  pdf.setFont(undefined, 'bold'); 
  // Centered Title: Y=50 works well in this space
  pdf.text('DYFI — TNPSC Signature Movement', pdfW / 2, 50, {align:'center'}); 
  pdf.setFont(undefined, 'normal'); 

  // 3. User Details - starting just below the header area (Y=100)
  const detailX = 40;
  let detailY = 100;
  const detailSpacing = 20;

  pdf.setFontSize(14); 
  pdf.text(`Name: ${name}`, detailX, detailY);
  detailY += detailSpacing;
  pdf.text(`Phone: ${number}`, detailX, detailY);
  detailY += detailSpacing;
  pdf.text(`District: ${district}`, detailX, detailY);
  detailY += detailSpacing;
  pdf.text(`Date: ${new Date().toLocaleString()}`, detailX, detailY);
  
  // 4. Signature Box Area - starts below details + margin (signY)
  const signY = detailY + 40; 
  const signH = pdfH - signY - 40; // Remaining height, with a 40pt bottom margin
  
  pdf.setLineWidth(1.5);
  pdf.rect(40, signY, pdfW - 80, signH);

  if(!signaturePad.isEmpty()){
    const dataUrl = signaturePad.toDataURL('image/png');
    // fit signature into box preserving aspect ratio
    const img = new Image();
    img.crossOrigin = 'anonymous'; 
    img.src = dataUrl;
    await new Promise(r => img.onload = r);
    const maxW = pdfW - 80;
    const maxH = signH;
    const ratio = Math.min(maxW / img.width, maxH / img.height);
    const drawW = img.width * ratio;
    const drawH = img.height * ratio;
    const drawX = 40 + (maxW - drawW)/2;
    const drawY = signY + (maxH - drawH)/2;
    pdf.addImage(dataUrl, 'PNG', drawX, drawY, drawW, drawH);
  } else {
    pdf.setFontSize(14);
    pdf.text('NO SIGNATURE', pdfW/2, signY + signH/2, {align:'center'}); 
  }

  return pdf.output('blob');
}


/* ----------------------------- PDF Menu UI ----------------------------- */
pdfMenuBtn.onclick = ()=> { pdfMenu.style.display = pdfMenu.style.display === 'block' ? 'none' : 'block'; };
previewBtn.onclick = async ()=>{
  if(signaturePad.isEmpty()){ showMessage('Please sign before previewing.'); return; }
  showMessage('Generating preview...');
  try{
    const blob = await createPDFBlob();
    const url = URL.createObjectURL(blob);
    window.open(url, '_blank');
  }catch(e){
    console.error(e);
    showMessage('Preview failed: '+(e.message||e));
  }finally{ msg.classList.remove('active'); msg.style.visibility='hidden'; msg.style.opacity='0'; pdfMenu.style.display='none'; }
};
downloadBtn.onclick = async ()=>{
  if(signaturePad.isEmpty()){ showMessage('Please sign before download.'); return; }
  try{
    const blob = await createPDFBlob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `DYFI_Sign_${new Date().toISOString().slice(0,10)}.pdf`;
    a.click();
  }catch(e){
    console.error(e);
    showMessage('Download failed: '+(e.message||e));
  }finally{ pdfMenu.style.display='none'; }
};

/* ----------------------------- Firebase counters (show live) ----------------------------- */
const sigCountRef = db.ref('signature_count');
const mailCountRef = db.ref('email_count');

// These listeners will now run because the syntax error was removed.
sigCountRef.on('value', snap => { sigCountEl.innerText = snap.exists() ? snap.val() : 0; });
mailCountRef.on('value', snap => { mailCountEl.innerText = snap.exists() ? snap.val() : 0; });

/* ----------------------------- Submit flow (Option B) ----------------------------- */
const WEB3_KEY = 'beeb8690-8cbb-464e-ad6d-87d3b6537a03'; // your Web3Forms key

submitBtn.onclick = async ()=>{
  const name = (document.getElementById('name').value||'').trim();
  const number = (document.getElementById('number').value||'').trim();
  const district = (document.getElementById('district').value||'').trim();
  if(!name) { showMessage('Enter your name'); return; }
  if(!number) { showMessage('Enter phone number'); return; }
  if(!district) { showMessage('Select district'); return; }
  if(signaturePad.isEmpty()){ showMessage('Please sign before submitting'); return; }

  submitBtn.disabled = true;
  submitBtn.innerText = 'Submitting...';

  try{
    // 1) Upload signature image to Firebase Storage
    const dataUrl = signaturePad.toDataURL('image/png');
    const blob = await (await fetch(dataUrl)).blob();
    const ts = Date.now();
    const path = `signatures/sign_${ts}.png`;
    const ref = storage.ref().child(path);
    await ref.put(blob);
    const downloadURL = await ref.getDownloadURL();

    // 2) Save full record under signatures/
    const pushRef = db.ref('signatures').push();
    const record = {
      name, number, district, signatureURL: downloadURL, createdAt: firebase.database.ServerValue.TIMESTAMP
    };
    await pushRef.set(record);

    // 3) Increment signature count
    await sigCountRef.transaction(current => (current || 0) + 1);

    // 4) Send email via Web3Forms with link (NOT attachment)
    const form = new FormData();
    form.append('access_key', WEB3_KEY);
    form.append('subject', `DYFI Signature — ${name}`);
    form.append('name', name);
    form.append('phone', number);
    form.append('district', district);
    form.append('message', `New signature submitted. Download: ${downloadURL}`);
    form.append('redirect', 'https://web3forms.com/success');

    const resp = await fetch('https://api.web3forms.com/submit', { method:'POST', body: form });
    const json = await resp.json();
    if(json.success){
      // increment mail count
      await mailCountRef.transaction(current => (current || 0) + 1);
      showMessage('Submitted successfully — email sent!');
      // clear form
      document.getElementById('name').value = '';
      document.getElementById('number').value = '';
      document.getElementById('district').value = '';
      signaturePad.clear();
    } else {
      showMessage('Saved, but email failed: ' + (json.message || 'unknown'));
    }
  } catch(err){
    console.error(err);
    showMessage('Submission failed: ' + (err.message || err));
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerText = 'Submit Details';
  }
};
</script>
</body>
</html>
