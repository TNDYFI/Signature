<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DYFI-Digital Signature Collector</title>
<!-- Load Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Load Signature Pad and jsPDF libraries -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    /* Custom Styling Overrides & Fonts */
    body { 
        font-family: 'Inter', system-ui, sans-serif; 
        background-color: #f0f4f8; /* Light blue background */
        color: #1e293b;
        min-height: 100vh;
    }
    .container-card {
        background: #ffffff;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        border: 1px solid #e2e8f0;
        max-width: 95%;
        transition: all 0.3s ease;
    }
    /* Style for inputs and select for consistency */
    input, select {
        padding: 12px;
        border: 1px solid #cbd5e1;
        border-radius: 0.5rem;
        transition: border-color 0.3s, box-shadow 0.3s;
        box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
    }
    input:focus, select:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        outline: none;
    }
    
    /* Signature Box Container */
    #box { 
        min-height: 35vh; 
        border: 2px dashed #93c5fd; /* Blue dashed border */
        background: #f8fafc; 
        position: relative; 
        border-radius: 0.75rem;
        box-shadow: inset 0 1px 4px rgba(0,0,0,0.05);
    }
    canvas { 
        width: 100%; 
        height: 100%; 
        display: block; 
        touch-action: none; /* Prevents scroll/zoom when signing on mobile */
    }

    /* Message Box for alerts (instead of native alerts) */
    .message-box {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        visibility: hidden;
        opacity: 0;
        transition: visibility 0s, opacity 0.3s;
    }
    .message-box.active {
        visibility: visible;
        opacity: 1;
    }
    .message-content {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
        max-width: 90%;
        width: 350px;
        text-align: center;
        transform: scale(0.9);
        transition: transform 0.3s;
    }
    .message-box.active .message-content {
        transform: scale(1);
    }
</style>
</head>
<body class="p-4 md:p-8">

<div class="container-card mx-auto p-6 sm:p-8 rounded-xl">
    
    <!-- Header and Count Display -->
    <header class="mb-6">
        <h3 class="text-2xl sm:text-3xl font-extrabold text-blue-800 mb-1">
            DYFI TNPSC பணியிட கையெழுத்து இயக்கம்
        </h3>
        <p class="text-gray-500 mb-4">
            Sign the box below and submit your details to join the campaign.
        </p>

        <!-- Live Signature Count Status -->
        <div id="countStatus" class="bg-indigo-50 border border-indigo-200 text-indigo-800 p-3 rounded-lg shadow-inner flex items-center justify-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-5a2 2 0 012-2h-5m-9 0H4v5a2 2 0 002 2h5m0-7a7 7 0 100-14 7 7 0 000 14z"></path></svg>
            <span id="signatureCount" class="font-bold text-lg">Initializing Database...</span>
        </div>
    </header>

    <!-- Input Fields -->
    <div class="space-y-4 mb-6">
        <input id="name" placeholder="Enter Your Name" class="w-full">
        <input id="number" type="tel" placeholder="Enter Your Phone Number" class="w-full">

        <!-- Native Place Select Dropdown -->
        <select id="district" class="w-full" required>
            <option value="" disabled selected>Choose Your District</option>
            <option value="Ariyalur">அரியலூர் - Ariyalur</option>
            <option value="Chengalpattu">செங்கல்பட்டு - Chengalpattu</option>
            <option value="Chennai">சென்னை - Chennai</option>
            <option value="Coimbatore">கோயம்புத்தூர் - Coimbatore</option>
            <option value="Cuddalore">கடலூர் - Cuddalore</option>
            <option value="Dharmapuri">தருமபுரி - Dharmapuri</option>
            <option value="Dindigul">திண்டுக்கல் - Dindigul</option>
            <option value="Erode">ஈரோடு - Erode</option>
            <option value="Kallakurichi">கள்ளக்குறிச்சி - Kallakurichi</option>
            <option value="Kancheepuram">காஞ்சிபுரம் - Kancheepuram</option>
            <option value="Kanyakumari">கன்னியாகுமரி - Kanyakumari</option>
            <option value="Karur">கரூர் - Karur</option>
            <option value="Krishnagiri">கிருஷ்ணகிரி - Krishnagiri</option>
            <option value="Madurai">மதுரை - மதுரை</option>
            <option value="Mayiladuthurai">மயிலாடுதுறை - Mayiladuthurai</option>
            <option value="Nagapattinam">நாகப்பட்டினம் - Nagapattinam</option>
            <option value="Namakkal">நாமக்கல் - Namakkal</option>
            <option value="Nilgiris">நீலகிரி - Nilgiris</option>
            <option value="Perambalur">பெரம்பலூர் - Perambalur</option>
            <option value="Pudukkottai">புதுக்கோட்டை - Pudukkottai</option>
            <option value="Ramanathapuram">இராமநாதபுரம் - Ramanathapuram</option>
            <option value="Ranipet">இராணிப்பேட்டை - Ranipet</option>
            <option value="Salem">சேலம் - Salem</option>
            <option value="Sivaganga">சிவகங்கை - Sivaganga</option>
            <option value="Tenkasi">தென்காசி - Tenkasi</option>
            <option value="Thanjavur">தஞ்சாவூர் - Thanjavur</option>
            <option value="Theni">தேனி - Theni</option>
            <option value="Thoothukudi">தூத்துக்குடி - Thoothukudi</option>
            <option value="Tiruchirappalli">திருச்சிராப்பள்ளி - Tiruchirappalli</option>
            <option value="Tirunelveli">திருநெல்வேலி - Tirunelveli</option>
            <option value="Tirupattur">திருப்பத்தூர் - Tirupattur</option>
            <option value="Tiruppur">திருப்பூர் - திருப்பூர்</option>
            <option value="Tiruvallur">திருவள்ளூர் - திருவள்ளூர்</option>
            <option value="Tiruvannamalai">திருவண்ணாமலை - Tiruvannamalai</option>
            <option value="Tiruvarur">திருவாரூர் - Tiruvarur</option>
            <option value="Vellore">வேலூர் - வேலூர்</option>
            <option value="Viluppuram">விழுப்புரம் - Viluppuram</option>
            <option value="Virudhunagar">விருதுநகர் - விருதுநகர்</option>
        </select>
    </div>


    <!-- Signature Pad -->
    <div id="box" class="mb-6">
        <canvas id="canvas"></canvas>
    </div>

    <!-- Controls -->
    <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-4 sm:space-y-0 mb-4">
        <button id="clear" class="flex-1 py-3 px-6 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition duration-200">
            Clear Signature
        </button>
        <button id="pdfMenuBtn" class="flex-1 py-3 px-6 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-lg transition duration-200">
            View/Download PDF
        </button>
    </div>

    <!-- PDF Menu -->
    <div id="pdfMenu" class="hidden flex-col space-y-2 mb-6 p-4 bg-gray-100 rounded-lg shadow-inner">
        <button id="previewBtn" class="py-2 px-4 bg-gray-700 hover:bg-gray-800 text-white rounded-lg">Preview PDF in New Tab</button>
        <button id="downloadBtn" class="py-2 px-4 bg-gray-700 hover:bg-gray-800 text-white rounded-lg">Download PDF to Device</button>
    </div>

    <!-- Submission Button -->
    <button id="save" class="w-full py-4 bg-green-600 hover:bg-green-700 text-white text-xl font-extrabold rounded-lg shadow-lg transition duration-200">
        Submit Details 
    </button>
</div>

<!-- Custom Message Box for Mobile Friendly Alerts -->
<div id="messageBox" class="message-box">
    <div class="message-content">
        <p id="messageText" class="text-gray-700"></p>
        <button onclick="document.getElementById('messageBox').classList.remove('active')" class="mt-4 py-2 px-6 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">OK</button>
    </div>
</div>

<script type="module">
    // --- Firebase Imports (These are needed for the functions to exist) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, addDoc, onSnapshot, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // --- Global Firebase & App Variables ---
    
    // Fallback configuration derived from the user's provided JSON
    const FALLBACK_FIREBASE_CONFIG = {
        apiKey: "AIzaSyBLyf_dz6xPC9wdthZSVtpatkc8JgFhE4Q",
        authDomain: "chatbox-chats.firebaseapp.com", 
        projectId: "chatbox-chats",
        storageBucket: "chatbox-chats.appspot.com",
        messagingSenderId: "10200860576", 
        appId: "1:10200860576:android:262315d86f6d1732ddc6c5"
    };

    // Use environment variables if available, otherwise use the fallback
    const appId = typeof __app_id !== 'undefined' ? __app_id : FALLBACK_FIREBASE_CONFIG.projectId;
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    let firebaseConfig;
    let rawFirebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : null;

    if (rawFirebaseConfig) {
        try {
            firebaseConfig = JSON.parse(rawFirebaseConfig);
        } catch (e) {
            console.error("Failed to parse Firebase Config from environment. Using fallback.");
            firebaseConfig = FALLBACK_FIREBASE_CONFIG;
        }
    } else {
        firebaseConfig = FALLBACK_FIREBASE_CONFIG;
    }


    let db;
    let auth;
    let userId = null;
    let isFirebaseReady = false;

    // --- Utility Function: Custom Alert/Message Box ---
    function showMessage(text) {
        document.getElementById('messageText').innerHTML = text;
        document.getElementById('messageBox').classList.add('active');
    }

    // --- 1. Firebase Initialization and Authentication ---
    async function initFirebase() {
        const countElement = document.getElementById('signatureCount');

        // Check if config keys exist (a basic health check)
        if (!firebaseConfig.apiKey || !firebaseConfig.projectId) {
            countElement.textContent = "Database Offline (Config Missing)";
            console.warn("Firebase configuration is missing or incomplete. Database features disabled.");
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Log in using the custom token or anonymously
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            // Set up Auth State Listener
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isFirebaseReady = true;
                    console.log("Firebase Auth Ready. User ID:", userId);
                    // Start listening to the signature count after successful authentication
                    setupSignatureCountListener();
                } else {
                    console.error("Authentication failed or logged out.");
                    countElement.textContent = "Database Offline (Auth Failed)";
                }
            });
        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            countElement.textContent = "Database Offline (Error)";
            showMessage("Database connection failed. Submission will still proceed via email.");
        }
    }
    
    // --- 2. Live Signature Count Listener ---
    function setupSignatureCountListener() {
        if (!isFirebaseReady || !db) return;

        const collectionPath = `artifacts/${appId}/public/data/signatures`;
        const q = collection(db, collectionPath);
        const signatureCountElement = document.getElementById('signatureCount');

        // Use onSnapshot to get the count in real-time
        onSnapshot(q, (snapshot) => {
            const count = snapshot.size;
            signatureCountElement.textContent = `${count.toLocaleString()} Submissions Counted`;
            console.log("Real-time Signature Count:", count);
        }, (error) => {
            console.error("Error listening to signature count:", error);
            signatureCountElement.textContent = "Count Error";
        });
    }


    // --- 3. Signature Pad Initialization ---
    const canvas = document.getElementById("canvas");
    const box = document.getElementById("box");
    let signaturePad;

    function resizeCanvas() {
        const data = signaturePad ? signaturePad.toData() : null;
        
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = box.clientWidth * ratio;
        canvas.height = box.clientHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        
        if (!signaturePad) {
            signaturePad = new SignaturePad(canvas, { 
                backgroundColor: "transparent", 
                penColor: "#0000FF", // Blue pen color
                maxWidth: 2, 
                minWidth: 0.5 
            });
        } else {
            signaturePad.clear();
            if (data && data.length > 0) {
                signaturePad.fromData(data);
            }
        }
    }
    
    window.addEventListener("resize", resizeCanvas);
    document.getElementById("clear").onclick = () => signaturePad.clear();
    
    // Initialize everything on load
    window.onload = () => {
        resizeCanvas();
        initFirebase(); // Attempt to initialize Firebase
    };


    // --- 4. Core PDF Generation Function (for Preview/Download) ---
    async function createPDF() {
        try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("landscape", "pt", "a4"); 
            const pdfWidth = pdf.internal.pageSize.getWidth();

            const name = document.getElementById("name").value.trim() || "Unsigned User";
            const district = document.getElementById("district").value || "Not Selected"; 
            
            // Title and Context
            pdf.setFontSize(18);
            pdf.text("DYFI: TNPSC 1-Lakh Job Vacancies Signature Campaign", 40, 40);
            
            pdf.setFontSize(12);
            pdf.text(`Signed By: ${name}`, 40, 65);
            pdf.text(`District: ${district}`, 40, 85); 
            pdf.text(`Date: ${new Date().toLocaleString()}`, 40, 105); 
            
            // Signature Area Border
            const signAreaY = 120; 
            const signAreaHeight = 380; 
            pdf.setLineWidth(2);
            pdf.setDrawColor(50, 50, 50); 
            pdf.rect(40, signAreaY, pdfWidth - 80, signAreaHeight); 

            // Add Signature (if present)
            if (!signaturePad.isEmpty()) {
                const imgData = signaturePad.toDataURL("image/png");
                // Fit signature image inside the rectangle
                pdf.addImage(imgData, "PNG", 40, signAreaY, pdfWidth - 80, signAreaHeight);
            } else {
                pdf.setFontSize(14);
                pdf.setTextColor(150);
                pdf.text("SIGNATURE AREA: Please sign above.", pdfWidth / 2, signAreaY + signAreaHeight / 2, { align: 'center' });
                pdf.setTextColor(0);
            }

            return pdf.output("blob");

        } catch (error) {
            console.error("PDF Generation Error:", error);
            showMessage("Error generating PDF: " + error.message);
            return null;
        }
    }

    // 5. PDF Menu & Action Handlers
    document.getElementById("pdfMenuBtn").onclick = () => {
        document.getElementById("pdfMenu").classList.toggle("hidden");
    };

    document.getElementById("previewBtn").onclick = async () => {
        const pdfBlob = await createPDF();
        if (pdfBlob) {
            const url = URL.createObjectURL(pdfBlob);
            window.open(url, "_blank");
        }
    };

    document.getElementById("downloadBtn").onclick = async () => {
        const pdfBlob = await createPDF();
        if (pdfBlob) {
            const url = URL.createObjectURL(pdfBlob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `Signed_DYFI_Document_${new Date().toISOString().slice(0, 10)}.pdf`;
            a.click();
        }
    };

    // 6. Submission Handler (Firebase & Web3Forms)
    document.getElementById("save").onclick = async () => {
        const name = document.getElementById("name").value.trim();
        const number = document.getElementById("number").value.trim();
        const district = document.getElementById("district").value;
        const btn = document.getElementById("save");

        // --- Validation ---
        if (!name) return showMessage("Please enter your **Name**.");
        if (!number) return showMessage("Please enter your **Phone Number**.");
        if (!district) return showMessage("Please select your **District**.");
        if (signaturePad.isEmpty()) return showMessage("Please **sign** the document before submitting."); 

        // UI Feedback during process
        btn.innerText = "Submitting...";
        btn.disabled = true;

        let firebaseSuccess = false;
        let emailSuccess = false;

        // --- Task A: Save Data to Firestore (Only if initialized) ---
        if (isFirebaseReady && db) {
            // Use a random UUID if user ID is somehow lost, ensuring the document is created.
            const currentUserId = userId || crypto.randomUUID(); 
            const signatureDataURL = signaturePad.toDataURL("image/png");
            const submissionData = {
                name: name,
                number: number,
                district: district,
                signatureData: signatureDataURL,
                timestamp: serverTimestamp(),
                userId: currentUserId 
            };
            
            const collectionPath = `artifacts/${appId}/public/data/signatures`;
            try {
                await addDoc(collection(db, collectionPath), submissionData);
                firebaseSuccess = true;
                console.log("Data successfully saved to Firestore.");
            } catch (error) {
                // If a security rule prevents write access, we still continue with the email
                console.error("Firestore Save Error (Will continue with email):", error);
            }
        } else {
             console.warn("Skipping Firestore save: Database not ready or config missing. Check console for init error.");
        }


        // --- Task B: Send Text Details via Web3Forms (Always attempt this) ---
        const formData = new FormData();
        formData.append("access_key", "6e1efc51-93b3-4ffc-8d33-a446ca6eacd8"); 
        formData.append("subject", `New Signature Submission from ${name} (${district})`); 
        formData.append("Name", name); 
        formData.append("Phone Number", number); 
        formData.append("District", district); 
        formData.append("message", `New signature details received. User signed on ${new Date().toLocaleString()}.`);

  
